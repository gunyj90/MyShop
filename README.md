## Homework 프로젝트 설명

상품주문 프로그램을 제공합니다.

상품 리스트를 참고하여 상품번호와 수량을 입력하고 주문서를 작성합니다.

주문서를 토대로 주문과 결제가 이루어 집니다.

여러 상품을 한번에 주문할 수 있으며 주문 후, 주문금액, 배송비, 총 지불금액을 확인할 수 있습니다.

## 실행방법

1. 프로젝트 설치 경로로 이동한다.

2. 명령어를 실행하여 jar파일을 생성한다.

```shell
./gradlew bootJar
```

3. 아래 명령어로 서버를 기동한다.

```shell
./gradlew bootRun 
```

> 서버기동 후 H2콘솔 접속이 가능합니다.
* [H2콘솔로 접속하기](http://localhost:8080/h2-console)

## 사용기술

* Java 22
* Spring boot 3.3.2
* Jpa
* H2
* Junit
* Opencsv

## 프로젝트 설계

### ER 다이어그램

<img width="480" alt="layer" src="https://github.com/user-attachments/assets/a5520593-51db-4ee6-8247-ee09b4ecafc1">

* ORDERS: 주문 테이블, 
* ORDER_ITEM: 주문상품 테이블, 
* ITEM: 상품 테이블


### 클래스 다이어그램

<img width="880" alt="layer" src="https://github.com/user-attachments/assets/1b45434c-525c-47d5-802e-4ca742c1ed0a">

* 위 표를 통해 클래스의 의존관계와 상속, 구현에 대한 정보를 알 수 있습니다.

### 패키지 다이어그램

<img width="480" alt="layer" src="https://github.com/user-attachments/assets/f81cab56-b7a9-48d5-872c-6c6da523ee3c">

* 도메인은 POJO로 구성되어 있고 어떤 layer도 참조하지 않습니다.
구체적 기술이 포함된 infrastructure는 어떤 layer로부터 참조되지 않습니다.
이는 도메인으로 부터 비즈니스 도메인을 이해하고 기술적인 부분을 분리하여 변경에 유용하게 설계하기 위함입니다.

## 문제인식 및 해결

**[동시주문에 대한 재고관리]** : 주문이 발생하면 요청한 상품수량 만큼 재고가 차감됩니다.
이때 재고가 0미만으로 변경되는 것을 방지해야 합니다.
Jpa사용시 상품의 재고를 읽고 어플리케이션 레벨에서 값을 변경하게 되면 커밋(flush)시점에 변경감지되어 재고값을 변경할 수 있습니다.
문제는 상품재고를 읽은 시점과 갱신 시점에 다른 접속자에 의해 값이 변경될 수 있다면 것입니다.
이는 Lock을 통해 데이터의 정합성을 유지할 수 있습니다.

> 비관적Lock: 데이터를 사용하는 동안 다른 트랜잭션이 해당 데이터에 접근하거나 수정하지 못하도록 합니다. 데이터에 대한 충돌이 발생할 가능성을 피하기 위해, 데이터에 접근할 때마다 잠금을 걸어 다른 트랜잭션이 접근하지 못하게 합니다.

> 낙관적Lock: 데이터 충돌이 드물게 발생할 것이라고 가정하고, 트랜잭션이 끝날 때까지 잠금을 사용하지 않습니다. 트랜잭션이 종료될 때 충돌 여부를 검사하여 충돌이 발생한 경우 트랜잭션을 롤백하고 다시 시도합니다.

비관적Lock이 프로그램의 성능을 저해할 수 있고 모든 트랜잭션의 순서를 보장하지 않아도 되는 수준임에 따라 낙관적Lock을 사용하였습니다. (순서를 보장하지 안되 요청수량에 따른 재고감소와 0이상을 유지키심을 목적으로 한다.)

앞서 설명한 변경감지(dirty check)를 사용하게 되면 데이터가 잘 못 수정될 가능성이 높습니다.

Jpa에서 제공하는 version을 통해 낙관적Lock을 구현할 수 있지만 코드가 복잡해 지고 DB접근량을 증가시킵니다.

따라서 Jpql을 통해 update문을 아래와 같이 작성하였습니다.
```code
update item set stock = stock - :요청수량 where stock >= :요청수량
```

수정된 row의 개수가 없을 경우 SoldOutException을 발생 시킵니다.


